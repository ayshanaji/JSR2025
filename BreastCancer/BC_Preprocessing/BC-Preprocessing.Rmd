---
title: "Gene Expression analysis"
author: "Ayisha - TRU- T00727585"
date: "2024-05-29"
output: html_document
---


```{r}
# Load required libraries
library(ggplot2)
library(reshape2)
library(viridis)
library(dplyr)

# Set global chunk options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load the dataset (preserve original column names with hyphens if present)
geneExpressionData <- read.table("cancergenepercentile.txt",
                                 header = TRUE,
                                 sep = "\t",
                                 stringsAsFactors = FALSE,
                                 check.names = FALSE)

# View dimensions of original dataset
cat("Original Dimensions (genes x samples):", dim(geneExpressionData), "\n")

# Transpose the data: keep 'sample' column for column names
geneTranspose <- t(geneExpressionData[, -1])  # exclude 'sample' column
colnames(geneTranspose) <- geneExpressionData$sample  # set new column names

# Convert transposed matrix into data frame with sampleID column
geneTranspose <- data.frame(sampleID = rownames(geneTranspose),
                            geneTranspose,
                            row.names = NULL)

# View new dimensions (samples x genes)
cat("Transposed Dimensions (samples x genes):", dim(geneTranspose), "\n")

```


```{r}
# Load survival data in R
survivalData <- read.table("CancerSurvivalmatrix.txt", 
                           header = TRUE, 
                           sep = "\t")
library(dplyr)
survivalData <- survivalData %>% rename(`sampleID` = sample)
```

Merge geneExpressionData and survival data using the unique id sample 



```{r}
# Merging the datasets on 'sampleID'
mergedData <- merge( survivalData,geneTranspose, by = "sampleID")
#View(mergedData)
# Check the first few rows of the merged dataset
dim(mergedData)
#names(mergedData)[1:15]
```

```{r}
# Load the dplyr package
library(dplyr)

# Find sampleIDs in survivalData not in geneTranspose
removed_from_geneTranspose <- anti_join(survivalData, geneTranspose, by = "sampleID")
removed_from_geneTranspose$sampleID

# Find sampleIDs in geneTranspose not in survivalData
removed_from_survivalData <- anti_join(geneTranspose, survivalData, by = "sampleID")
removed_from_survivalData$sampleID

```


```{r}

# Using grepl to create a logical vector
has_minus_eleven <- grepl("-11", mergedData$sampleID)

# Check if there are any TRUE values in the vector
if (any(has_minus_eleven)) {
  cat("There are sample IDs with '-11'.\n")
} else {
  cat("There are no sample IDs with '-11'.\n")
}

# To see the actual sample IDs containing '-11'
sample_ids_with_minus_eleven <- mergedData$sampleID[has_minus_eleven]
print(sample_ids_with_minus_eleven)

```


```{r}
# Filter out rows where 'sampleID' contains '-11'
mergedData <- mergedData %>% 
  filter(!grepl("-11", sampleID))
```

```{r}
# Check the dimensions of the merged data
cat("Dimensions of the merged data: \n")
print(dim(mergedData))

# View the structure of the merged data
cat("Structure of the merged data: \n")
str(mergedData)

# Summarize the dataset
cat("Summary of the merged data: \n")
#summary(mergedData)


```

```{r}

# Calculate the number of missing values per column
missing_summary <- sapply(mergedData, function(x) sum(is.na(x)))

# Create a data frame to summarize missing data
missing_data_df <- data.frame(
  Column = names(missing_summary),
  MissingCount = missing_summary,
  MissingProportion = missing_summary / nrow(mergedData) * 100
)

# Filter to retain columns where the MissingCount is greater than 0
missing_data_df <- missing_data_df[missing_data_df$MissingCount > 0, ]

# Identify names of columns with any missing values
columns_with_na <- names(missing_summary[missing_summary > 0])

# Remove columns with any missing values from mergedData
#mergedData_clean <- mergedData[, !(names(mergedData) %in% columns_with_na)]
print(missing_data_df)
```

```{r}
# Calculate the number of missing values per column
missing_summary <- sapply(mergedData, function(x) sum(is.na(x)))

# Create a data frame to summarize missing data
missing_data_df <- data.frame(
  Column = names(missing_summary),
  MissingCount = missing_summary,
  MissingProportion = missing_summary / nrow(mergedData) * 100
)

# Filter to retain columns where the MissingCount is greater than 0
missing_data_df <- missing_data_df[missing_data_df$MissingCount > 0, ]

# Identify names of columns with any missing values, excluding 'DSS'
columns_with_na <- names(missing_summary[missing_summary > 0])
columns_to_remove <- setdiff(columns_with_na, "DSS")

# Remove columns with any missing values from mergedData, except for 'DSS'
mergedData_clean <- mergedData[, !(names(mergedData) %in% columns_to_remove)]

# Optionally, print the cleaned data summary
#print(summary(mergedData_clean))

```

```{r}
# Remove specific columns from the dataframe
mergedData_clean <- mergedData_clean %>%
 select(-sampleID, -X_PATIENT, -PFI, -Redaction,-OS)

# View the first few rows of the cleaned data to confirm
#View(mergedData_clean)
dim(mergedData_clean)
```

```{r}
# Save the cleaned dataframe to a CSV file
write.csv(mergedData_clean, "mergedData_clean.csv", row.names = FALSE)

```







```{r}
# Convert the 'gene' column to a factor
mergedData_clean$DSS <- as.factor(mergedData_clean$DSS)

# Verify the conversion
class(mergedData_clean$DSS)
levels(mergedData_clean$DSS)

#str(gene)

```


```{r}
# Identify categorical variables (factors and characters)
categorical_vars <- names(mergedData_clean)[sapply(mergedData_clean, function(x) is.factor(x) || is.character(x))]

# Display the categorical columns
#print(categorical_vars)

```

```{r}
dim(mergedData_clean)
# Check unique values in the DSS column
unique(mergedData_clean$DSS)
```

```{r}
# Remove rows where the DSS column has NA values from the gene dataset
mergedData_clean <- mergedData_clean[!is.na(mergedData_clean$DSS), ]
dim(mergedData_clean)
# Optionally, print the cleaned data summary
#print(summary(gene_clean))
```


```{r}
# Function to calculate unique counts and percentages for a specific column
get_unique_counts_os <- function(data, column) {
  # Calculate the counts of unique values
  counts <- data %>%
    group_by(!!sym(column)) %>%
    summarise(Count = n()) %>%
    mutate(Percentage = round((Count / nrow(data)) * 100, 2)) %>%
    arrange(desc(Count))
  
  # Add the column name for reference
  counts <- counts %>%
    mutate(Column = column) %>%
    dplyr::select(Column, everything())
  
  return(counts)
}

# Apply the function to the 'mergedData_clean$OS' column
unique_counts_os_summary <- get_unique_counts_os(mergedData_clean, "DSS")

# Display the summary
print(unique_counts_os_summary)

# Save the summary to a CSV file for further analysis
#write.csv(unique_counts_os_summary, "unique_counts_os_summary.csv", row.names = FALSE)


```


















```{r}
# Load data again for consistency (in case of re-runs)
geneExpressionData <- read.table("cancergenepercentile.txt", 
                                 header = TRUE, 
                                 sep = "\t", 
                                 stringsAsFactors = FALSE, 
                                 check.names = FALSE)

# Set gene names as rownames, remove 'sample' column
rownames(geneExpressionData) <- geneExpressionData$sample
geneExpressionData <- geneExpressionData[, -1]

# Select the first 50 genes (rows)
geneSubset <- geneExpressionData[1:50, ]
geneSubset$Gene <- rownames(geneSubset)  # Add gene names as column

# Reshape to long format for ggplot
geneLong <- melt(geneSubset, id.vars = "Gene", 
                 variable.name = "Sample", 
                 value.name = "Expression")

# Assign numeric index to each sample for plotting
geneLong$SampleIndex <- as.numeric(factor(geneLong$Sample, levels = unique(geneLong$Sample)))

# Define breaks for x-axis labels (every 100 samples, optional)
x_breaks <- seq(0, max(geneLong$SampleIndex), by = 100)

# Generate heatmap plot
ggplot(geneLong, aes(x = SampleIndex, y = Gene, fill = Expression)) +
  geom_tile() +
  scale_fill_viridis(option = "magma", name = "Expression (%)", limits = c(0, 100)) +
  scale_x_continuous(breaks = x_breaks, labels = x_breaks) +
  labs(title = "Gene Expression of First 50 Genes",
       x = "Sample Index",
       y = "Gene") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 6),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(face = "bold"),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

```



